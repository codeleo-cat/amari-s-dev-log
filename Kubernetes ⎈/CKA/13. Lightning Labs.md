1. Upgrade the current version of kubernetes from `1.29.0` to `1.30.0` exactly using the `kubeadm` utility. Make sure that the upgrade is carried out one node at a time starting with the controlplane node. To minimize downtime, the deployment `gold-nginx` should be rescheduled on an alternate node before upgrading each node.

Upgrade `controlplane` node first and drain node `node01` before upgrading it. Pods for `gold-nginx` should run on the `controlplane` node subsequently.
해당 노드에서 실행 중인 파드를 다른 노드로 옮겨서 ***서비스 중단을 최소화***하는 것

- [kubeadm-upgrade](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)

1. **controlplane node upgrade**
- master node drain
- kubeadm upgrade
- kubelet과 kubectl upgrade
- upgrade 상태 확인
- master node uncordon

2. **worker node upgrade**
	node drain
	**ssh로 해당 node 접속**
	kubeadm upgrade
	kubelet과 kubectl 업그레이드
	**해당 node exit**
	node uncordon

### Check node & pod status
```sh
k get po && k get no
```

```plain
NAME                          READY   STATUS    RESTARTS   AGE
gold-nginx-5d9489d9cc-hqj8d   1/1     Running   0          29s

NAME           STATUS   ROLES           AGE   VERSION
controlplane   Ready    control-plane   71m   v1.29.0
node01         Ready    <none>          70m   v1.29.0
```
# Upgrading control plane nodes 
**etc. apt. sourcelistd. k (eask)**
cat /etc/apt/sources.list.d/kubernetes.list
```plain
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /
```

```sh
sed -i 's/1.29/1.30/g' /etc/apt/sources.list.d/kubernetes.list
```

cat /etc/apt/sources.list.d/kubernetes.list 
```plain
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /
```

```sh
# Find the latest patch release for Kubernetes
sudo apt update
sudo apt-cache madison kubeadm
```

```plain
   kubeadm | 1.30.3-1.1 | https://pkgs.k8s.io/core:/stable:/v1.30/deb  Packages
   kubeadm | 1.30.2-1.1 | https://pkgs.k8s.io/core:/stable:/v1.30/deb  Packages
   kubeadm | 1.30.1-1.1 | https://pkgs.k8s.io/core:/stable:/v1.30/deb  Packages
   kubeadm | 1.30.0-1.1 | https://pkgs.k8s.io/core:/stable:/v1.30/deb  Packages
```

```sh
# Upgrade kubeadm
sudo apt-mark unhold kubeadm && \
sudo apt-get update && sudo apt-get install -y kubeadm='1.30.0-1.1' && \
sudo apt-mark hold kubeadm

# Verify the version & upgrade plan
kubeadm version
```

```plain
kubeadm version: &version.Info{Major:"1", Minor:"30", GitVersion:"v1.30.0", GitCommit:"7c48c2bd72b9bf5c44d21d7338cc7bea77d0ad2a", GitTreeState:"clean", BuildDate:"2024-04-17T17:34:08Z", GoVersion:"go1.22.2", Compiler:"gc", Platform:"linux/amd64"}
```

```sh
sudo kubeadm upgrade plan
sudo kubeadm upgrade apply v1.30.0
y
```
(This can take up to 5m0s...)
```plain
[upgrade/successful] SUCCESS! Your cluster was upgraded to "v1.30.0". Enjoy!

[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven't already done so.
```

```sh
# Drain the Node
kubectl drain controlplane --ignore-daemonsets

# Upgrade the kubelet and kubectl
sudo apt-mark unhold kubelet kubectl && \
sudo apt-get update && sudo apt-get install -y kubelet='1.30.0-1.1' kubectl='1.30.0-1.1' && \
sudo apt-mark hold kubelet kubectl

# Restart the kubelet
sudo systemctl daemon-reload
sudo systemctl restart kubelet

# Uncordon the node
k uncordon controlplane
```

# Upgrade Worker Node
```sh
# Move to the node
ssh node01

sed -i 's/1.29/1.30/g' /etc/apt/sources.list.d/kubernetes.list

# Upgrade the kubeadm
sudo apt-mark unhold kubeadm && \
sudo apt-get update && sudo apt-get install -y kubeadm='1.30.0-1.1' && \
sudo apt-mark hold kubeadm

kubeadm version

# Call "kubeadm upgrade"
sudo kubeadm upgrade node

exit
# Drain the node (execute this command on a control plane node)
k drain node01 --ignore-daemonsets

# pod 확인
k get po -o wide
```

```plain
NAME                          READY   STATUS              RESTARTS   AGE   IP       NODE           NOMINATED NODE   READINESS GATES
gold-nginx-5d9489d9cc-j79cn   0/1     ContainerCreating   0          9s    <none>   controlplane   <none>  
```

```sh
# 다시 node01로 이동
ssh node01

# Upgrade the kubelet and kubectl
sudo apt-mark unhold kubelet kubectl && \
sudo apt-get update && sudo apt-get install -y kubelet='1.30.0-1.1' kubectl='1.30.0-1.1' && \
sudo apt-mark hold kubelet kubectl

# Restart the kubelet
sudo systemctl daemon-reload
sudo systemctl restart kubelet

exit

# Back on the `controlplane` node & Uncordon the node
k uncordon node01

# Check
k get no
k get pod -o wide | grep gold # make sure this is scheduled on a node
```

2. Print the names of all deployments in the `admin2406` namespace in the following format:  
  
`DEPLOYMENT CONTAINER_IMAGE READY_REPLICAS NAMESPACE`  
  
`<deployment name> <container image used> <ready replica count> <Namespace>`  
. The data should be sorted by the increasing order of the `deployment name`.

Example:  
  
`DEPLOYMENT CONTAINER_IMAGE READY_REPLICAS NAMESPACE`  
`deploy0 nginx:alpine 1 admin2406`  
Write the result to the file `/opt/admin2406_data`.

k get deploy -n admin2406 -o json
```json
{
    "apiVersion": "v1",
    "items": [
        {
            "apiVersion": "apps/v1",
            "kind": "Deployment",
            "metadata": {
                "annotations": {
                    "deployment.kubernetes.io/revision": "1"
                },
                "creationTimestamp": "2024-07-22T04:38:32Z",
                "generation": 1,
                "labels": {
                    "app": "deploy1"
                },
                "name": "deploy1",
                "namespace": "admin2406",
                "resourceVersion": "7527",
                "uid": "68cfa832-171c-49be-a299-1a9ffaa22adb"
            },
            "spec": {
                "progressDeadlineSeconds": 600,
                "replicas": 1,
                "revisionHistoryLimit": 10,
                "selector": {
                    "matchLabels": {
                        "app": "deploy1"
                    }
                },
                "strategy": {
                    "rollingUpdate": {
                        "maxSurge": "25%",
                        "maxUnavailable": "25%"
                    },
                    "type": "RollingUpdate"
                },
                "template": {
                    "metadata": {
                        "creationTimestamp": null,
                        "labels": {
                            "app": "deploy1"
                        }
                    },
                    "spec": {
                        "containers": [
                            {
                                "image": "nginx",
                                "imagePullPolicy": "Always",
                                "name": "nginx",
                                "resources": {},
                                "terminationMessagePath": "/dev/termination-log",
                                "terminationMessagePolicy": "File"
                            }
                        ],
                        "dnsPolicy": "ClusterFirst",
                        "restartPolicy": "Always",
                        "schedulerName": "default-scheduler",
                        "securityContext": {},
                        "terminationGracePeriodSeconds": 30
                    }
                }
            },
            "status": {
                "availableReplicas": 1,
                "conditions": [
                    {
                        "lastTransitionTime": "2024-07-22T04:38:32Z",
                        "lastUpdateTime": "2024-07-22T04:38:35Z",
                        "message": "ReplicaSet \"deploy1-67b55d4f9f\" has successfully progressed.",
                        "reason": "NewReplicaSetAvailable",
                        "status": "True",
                        "type": "Progressing"
                    },
                    {
                        "lastTransitionTime": "2024-07-22T04:45:44Z",
                        "lastUpdateTime": "2024-07-22T04:45:44Z",
                        "message": "Deployment has minimum availability.",
                        "reason": "MinimumReplicasAvailable",
                        "status": "True",
                        "type": "Available"
                    }
                ],
                "observedGeneration": 1,
                "readyReplicas": 1,
                "replicas": 1,
                "updatedReplicas": 1
            }
        },
        {
            "apiVersion": "apps/v1",
            "kind": "Deployment",
            "metadata": {
                "annotations": {
                    "deployment.kubernetes.io/revision": "1"
                },
                "creationTimestamp": "2024-07-22T04:38:32Z",
                "generation": 1,
                "labels": {
                    "app": "deploy2"
                },
                "name": "deploy2",
                "namespace": "admin2406",
                "resourceVersion": "7424",
                "uid": "808a5fd2-3764-40c4-95a7-5cc4d152dcc5"
            },
            "spec": {
                "progressDeadlineSeconds": 600,
                "replicas": 1,
                "revisionHistoryLimit": 10,
                "selector": {
                    "matchLabels": {
                        "app": "deploy2"
                    }
                },
                "strategy": {
                    "rollingUpdate": {
                        "maxSurge": "25%",
                        "maxUnavailable": "25%"
                    },
                    "type": "RollingUpdate"
                },
                "template": {
                    "metadata": {
                        "creationTimestamp": null,
                        "labels": {
                            "app": "deploy2"
                        }
                    },
                    "spec": {
                        "containers": [
                            {
                                "image": "nginx:alpine",
                                "imagePullPolicy": "IfNotPresent",
                                "name": "nginx",
                                "resources": {},
                                "terminationMessagePath": "/dev/termination-log",
                                "terminationMessagePolicy": "File"
                            }
                        ],
                        "dnsPolicy": "ClusterFirst",
                        "restartPolicy": "Always",
                        "schedulerName": "default-scheduler",
                        "securityContext": {},
                        "terminationGracePeriodSeconds": 30
                    }
                }
            },
            "status": {
                "availableReplicas": 1,
                "conditions": [
                    {
                        "lastTransitionTime": "2024-07-22T04:38:32Z",
                        "lastUpdateTime": "2024-07-22T04:38:35Z",
                        "message": "ReplicaSet \"deploy2-5d4697f587\" has successfully progressed.",
                        "reason": "NewReplicaSetAvailable",
                        "status": "True",
                        "type": "Progressing"
                    },
                    {
                        "lastTransitionTime": "2024-07-22T04:45:32Z",
                        "lastUpdateTime": "2024-07-22T04:45:32Z",
                        "message": "Deployment has minimum availability.",
                        "reason": "MinimumReplicasAvailable",
                        "status": "True",
                        "type": "Available"
                    }
                ],
                "observedGeneration": 1,
                "readyReplicas": 1,
                "replicas": 1,
                "updatedReplicas": 1
            }
        },
        {
            "apiVersion": "apps/v1",
            "kind": "Deployment",
            "metadata": {
                "annotations": {
                    "deployment.kubernetes.io/revision": "1"
                },
                "creationTimestamp": "2024-07-22T04:38:32Z",
                "generation": 1,
                "labels": {
                    "app": "deploy3"
                },
                "name": "deploy3",
                "namespace": "admin2406",
                "resourceVersion": "7516",
                "uid": "d1743887-eaf4-41d7-8405-ba0d384c7758"
            },
            "spec": {
                "progressDeadlineSeconds": 600,
                "replicas": 1,
                "revisionHistoryLimit": 10,
                "selector": {
                    "matchLabels": {
                        "app": "deploy3"
                    }
                },
                "strategy": {
                    "rollingUpdate": {
                        "maxSurge": "25%",
                        "maxUnavailable": "25%"
                    },
                    "type": "RollingUpdate"
                },
                "template": {
                    "metadata": {
                        "creationTimestamp": null,
                        "labels": {
                            "app": "deploy3"
                        }
                    },
                    "spec": {
                        "containers": [
                            {
                                "image": "nginx:1.16",
                                "imagePullPolicy": "IfNotPresent",
                                "name": "nginx",
                                "resources": {},
                                "terminationMessagePath": "/dev/termination-log",
                                "terminationMessagePolicy": "File"
                            }
                        ],
                        "dnsPolicy": "ClusterFirst",
                        "restartPolicy": "Always",
                        "schedulerName": "default-scheduler",
                        "securityContext": {},
                        "terminationGracePeriodSeconds": 30
                    }
                }
            },
            "status": {
                "availableReplicas": 1,
                "conditions": [
                    {
                        "lastTransitionTime": "2024-07-22T04:38:32Z",
                        "lastUpdateTime": "2024-07-22T04:38:38Z",
                        "message": "ReplicaSet \"deploy3-59985b7bb9\" has successfully progressed.",
                        "reason": "NewReplicaSetAvailable",
                        "status": "True",
                        "type": "Progressing"
                    },
                    {
                        "lastTransitionTime": "2024-07-22T04:45:43Z",
                        "lastUpdateTime": "2024-07-22T04:45:43Z",
                        "message": "Deployment has minimum availability.",
                        "reason": "MinimumReplicasAvailable",
                        "status": "True",
                        "type": "Available"
                    }
                ],
                "observedGeneration": 1,
                "readyReplicas": 1,
                "replicas": 1,
                "updatedReplicas": 1
            }
        },
        {
            "apiVersion": "apps/v1",
            "kind": "Deployment",
            "metadata": {
                "annotations": {
                    "deployment.kubernetes.io/revision": "1"
                },
                "creationTimestamp": "2024-07-22T04:38:32Z",
                "generation": 1,
                "labels": {
                    "app": "deploy4"
                },
                "name": "deploy4",
                "namespace": "admin2406",
                "resourceVersion": "7499",
                "uid": "34ae6b02-8e2a-4717-9e35-9ca5c13588f8"
            },
            "spec": {
                "progressDeadlineSeconds": 600,
                "replicas": 1,
                "revisionHistoryLimit": 10,
                "selector": {
                    "matchLabels": {
                        "app": "deploy4"
                    }
                },
                "strategy": {
                    "rollingUpdate": {
                        "maxSurge": "25%",
                        "maxUnavailable": "25%"
                    },
                    "type": "RollingUpdate"
                },
                "template": {
                    "metadata": {
                        "creationTimestamp": null,
                        "labels": {
                            "app": "deploy4"
                        }
                    },
                    "spec": {
                        "containers": [
                            {
                                "image": "nginx:1.17",
                                "imagePullPolicy": "IfNotPresent",
                                "name": "nginx",
                                "resources": {},
                                "terminationMessagePath": "/dev/termination-log",
                                "terminationMessagePolicy": "File"
                            }
                        ],
                        "dnsPolicy": "ClusterFirst",
                        "restartPolicy": "Always",
                        "schedulerName": "default-scheduler",
                        "securityContext": {},
                        "terminationGracePeriodSeconds": 30
                    }
                }
            },
            "status": {
                "availableReplicas": 1,
                "conditions": [
                    {
                        "lastTransitionTime": "2024-07-22T04:38:33Z",
                        "lastUpdateTime": "2024-07-22T04:38:42Z",
                        "message": "ReplicaSet \"deploy4-c669bb985\" has successfully progressed.",
                        "reason": "NewReplicaSetAvailable",
                        "status": "True",
                        "type": "Progressing"
                    },
                    {
                        "lastTransitionTime": "2024-07-22T04:45:39Z",
                        "lastUpdateTime": "2024-07-22T04:45:39Z",
                        "message": "Deployment has minimum availability.",
                        "reason": "MinimumReplicasAvailable",
                        "status": "True",
                        "type": "Available"
                    }
                ],
                "observedGeneration": 1,
                "readyReplicas": 1,
                "replicas": 1,
                "updatedReplicas": 1
            }
        },
        {
            "apiVersion": "apps/v1",
            "kind": "Deployment",
            "metadata": {
                "annotations": {
                    "deployment.kubernetes.io/revision": "1"
                },
                "creationTimestamp": "2024-07-22T04:38:33Z",
                "generation": 1,
                "labels": {
                    "app": "deploy5"
                },
                "name": "deploy5",
                "namespace": "admin2406",
                "resourceVersion": "7525",
                "uid": "07a421ea-8944-4bec-ac19-e557312a30d7"
            },
            "spec": {
                "progressDeadlineSeconds": 600,
                "replicas": 1,
                "revisionHistoryLimit": 10,
                "selector": {
                    "matchLabels": {
                        "app": "deploy5"
                    }
                },
                "strategy": {
                    "rollingUpdate": {
                        "maxSurge": "25%",
                        "maxUnavailable": "25%"
                    },
                    "type": "RollingUpdate"
                },
                "template": {
                    "metadata": {
                        "creationTimestamp": null,
                        "labels": {
                            "app": "deploy5"
                        }
                    },
                    "spec": {
                        "containers": [
                            {
                                "image": "nginx:latest",
                                "imagePullPolicy": "Always",
                                "name": "nginx",
                                "resources": {},
                                "terminationMessagePath": "/dev/termination-log",
                                "terminationMessagePolicy": "File"
                            }
                        ],
                        "dnsPolicy": "ClusterFirst",
                        "restartPolicy": "Always",
                        "schedulerName": "default-scheduler",
                        "securityContext": {},
                        "terminationGracePeriodSeconds": 30
                    }
                }
            },
            "status": {
                "availableReplicas": 1,
                "conditions": [
                    {
                        "lastTransitionTime": "2024-07-22T04:38:33Z",
                        "lastUpdateTime": "2024-07-22T04:38:42Z",
                        "message": "ReplicaSet \"deploy5-7d5f6f769b\" has successfully progressed.",
                        "reason": "NewReplicaSetAvailable",
                        "status": "True",
                        "type": "Progressing"
                    },
                    {
                        "lastTransitionTime": "2024-07-22T04:45:44Z",
                        "lastUpdateTime": "2024-07-22T04:45:44Z",
                        "message": "Deployment has minimum availability.",
                        "reason": "MinimumReplicasAvailable",
                        "status": "True",
                        "type": "Available"
                    }
                ],
                "observedGeneration": 1,
                "readyReplicas": 1,
                "replicas": 1,
                "updatedReplicas": 1
            }
        }
    ],
    "kind": "List",
    "metadata": {
        "resourceVersion": ""
    }
}
```

k get deploy -n admin2406 \
-o custom-columns=DEPLOYMENT: metadata.name, \
CONTAINER_IMAGE: .spec.template.spec.containers[].image,\
READY_REPLICAS: .status.readyReplicas, \ 
NAMESPACE: .metadata.namespace \
--sort-by=.metadata.name > /opt/admin2406_data


k get deploy -o custom-columns=DEPLOYMENT:.metadata.name,CONTAINER_IMAGE:..image,READY_REPLICAS:..replicas,NAMESPACE:..namespace