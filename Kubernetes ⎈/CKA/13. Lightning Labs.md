1. Upgrade the current version of kubernetes from `1.29.0` to `1.30.0` exactly using the `kubeadm` utility. Make sure that the upgrade is carried out one node at a time starting with the controlplane node. To minimize downtime, the deployment `gold-nginx` should be rescheduled on an alternate node before upgrading each node.

Upgrade `controlplane` node first and drain node `node01` before upgrading it. Pods for `gold-nginx` should run on the `controlplane` node subsequently.
해당 노드에서 실행 중인 파드를 다른 노드로 옮겨서 ***서비스 중단을 최소화***하는 것

- [kubeadm-upgrade](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)

1. **controlplane node upgrade**
- master node drain
- kubeadm upgrade
- kubelet과 kubectl upgrade
- upgrade 상태 확인
- master node uncordon

2. **worker node upgrade**
	node drain
	**ssh로 해당 node 접속**
	kubeadm upgrade
	kubelet과 kubectl 업그레이드
	**해당 node exit**
	node uncordon

### check node & pod status
k get po && k get no

## Upgrading control plane nodes 
**etc. apt. sourcelistd. k (eask)**
cat /etc/apt/sources.list.d/kubernetes.list
```plain
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /
```

```sh
sed -i 's/1.29/1.30/g' /etc/apt/sources.list.d/kubernetes.list
```

cat /etc/apt/sources.list.d/kubernetes.list 
```plain
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /
```

```sh
kubectl drain controlplane --ignore-daemonsets
sudo apt update
sudo apt-cache madison kubeadm
```

```plain
   kubeadm | 1.30.2-1.1 | https://pkgs.k8s.io/core:/stable:/v1.30/deb  Packages
   kubeadm | 1.30.1-1.1 | https://pkgs.k8s.io/core:/stable:/v1.30/deb  Packages
   kubeadm | 1.30.0-1.1 | https://pkgs.k8s.io/core:/stable:/v1.30/deb  Packages
```

```sh
sudo apt-mark unhold kubeadm && \
sudo apt-get update && sudo apt-get install -y kubeadm='1.30.0-1.1' && \
sudo apt-mark hold kubeadm

kubeadm version
sudo kubeadm upgrade plan
sudo kubeadm upgrade apply v1.30.0
```
(This can take up to 5m0s...)
```plain
[upgrade/successful] SUCCESS! Your cluster was upgraded to "v1.30.0". Enjoy!

[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven't already done so.
```

```sh
sudo apt-mark unhold kubelet kubectl && \
sudo apt-get update && sudo apt-get install -y kubelet='1.30.0-1.1' kubectl='1.30.0-1.1' && \
sudo apt-mark hold kubelet kubectl

kubectl uncordon controlplane
```

## Worker node upgrade
```sh
# Move to the node
ssh node01

sed -i 's/1.29/1.30/g' /etc/apt/sources.list.d/kubernetes.list

apt update
apt-cache madison kubeadm
apt-get install kubeadm=1.30.0-1.1
y

# Call "kubeadm upgrade"
sudo kubeadm upgrade node

exit
# Drain the node (execute this command on a control plane node)
k drain node01 --ignore-daemonsets

k get po `pode name` -o yaml | grep taint	

k taint no controlplane node-role.kubernetes.io/control-plane:NoSchedule

# Control Plane 노드에 배치 가능
• Control Plane 노드에 설정된 taint가 node-role.kubernetes.io/control-plane:NoSchedule와 일치하는 경우, tolerations 섹션에 해당 taint를 추가하여 파드를 해당 노드에 스케줄링할 수 있습니다.

# pod 확인
k get po -o wide

# 다시 node01로 이동
ssh node01

# Upgrade the kubelet and kubectl
sudo apt-mark unhold kubelet kubectl && \
sudo apt-get update && sudo apt-get install -y kubelet='1.30.0-1.1' kubectl='1.30.0-1.1' && \
sudo apt-mark hold kubelet kubectl

# Restart the kubelet
sudo systemctl daemon-reload
sudo systemctl restart kubelet

exit / logout

# Back on the `controlplane` node:
kubectl uncordon node01

k get no
k get pod -o wide | grep gold # make sure this is scheduled on a node
```

# [taint & toleration](https://nice-engineer.tistory.com/entry/Kubernetes-Taint-Toleration)